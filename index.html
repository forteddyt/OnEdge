<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Bing Meteor Game</title>
    <style>
    	* { padding: 0; margin: 0; }
    	canvas { background: #eee; display: block; margin: 0 auto; }
    </style>
</head>
<body>

<canvas id="gameCanvas" width="480" height="320"></canvas>



<script>
var canvas = document.getElementById("gameCanvas");
var ctx = canvas.getContext("2d");
var charHeight = 30;
var platformHeight = 10;
var charWidth = 20;
var meteorRad = 5;
var platformWidth = canvas.width*2/3;
var platformX = (canvas.width-platformWidth)/2; //left bound of the platform
var charX = canvas.width / 2; //left bound of the character
var rightPressed = false; //true iff right keyboard was pressed
var leftPressed = false; //true iff left keyboard was pressed
var meteors = []; //array of all meteors on screen
var frameCount = 0; //ticker that increments each frame
var gameOver = false; //true iff game player has lost
var charSpeed = 2;//default movement speed of the player per frame
var meteorSpeed = 1; //default fall speed for meteors per frame


var interval = setInterval(draw, 10);//sets max framerate of the game

//animation
var scoreFlashDuration = 0;
var scoreFlashValue = 0;
const SCORE_FLASH_FRAMES = 240;
const SCORE_FLASH_SPEED = 30;

document.addEventListener("keydown", keyDownHandler, false);
document.addEventListener("keyup", keyUpHandler, false);


//Input Handling
function keyDownHandler(e) {
    if(e.key == "Right" || e.key == "ArrowRight") {
        rightPressed = true;
    }
    else if(e.key == "Left" || e.key == "ArrowLeft") {
        leftPressed = true;
    }
}

function keyUpHandler(e) {
    if(e.key == "Right" || e.key == "ArrowRight") {
        rightPressed = false;
    }
    else if(e.key == "Left" || e.key == "ArrowLeft") {
        leftPressed = false;
    }
}

//Drawing
function drawChar() {
    ctx.beginPath();
    ctx.rect(charX, canvas.height-charHeight-platformHeight, charWidth, charHeight);
    ctx.fillStyle = "#0095DD";
    ctx.fill();
    ctx.closePath();
}

function drawPlatform() {
    ctx.beginPath();
    ctx.rect(platformX, canvas.height-platformHeight, platformWidth, platformHeight);
    ctx.fillStyle = "#0095DD";
    ctx.fill();
    ctx.closePath();
}

function drawMeteors() {
	for (i = 0; i < meteors.length; i++) {
	    ctx.beginPath();
	    ctx.arc(meteors[i].x + meteorRad/2, meteors[i].y + meteorRad/2, meteorRad, 0, Math.PI*2);
	    ctx.fillStyle = "#0095DD";
	    ctx.fill();
	    ctx.closePath();
	}
}

function drawScoreCounter() {
	var score = Math.floor(frameCount/5);
	ctx.font = "20px Monospace";
	if (score == 100 || score == 500 || score == 1000 || score == 2000 || score == 5000) {
		scoreFlashDuration = SCORE_FLASH_FRAMES;
		scoreFlashValue = score;
	}
	if (scoreFlashDuration > 0) {
		scoreFlashDuration--;
		if (Math.floor(scoreFlashDuration / SCORE_FLASH_SPEED) % 2 == 1) {
			ctx.fillText(scoreFlashValue, 10, 20);
		}
	} else {
		ctx.fillText(score, 10, 20);
	}
}

//Game Controllers
function spawnMeteor() {
	var meteorX = Math.random()*(canvas.width - 2*meteorRad) + meteorRad;
	meteors.push({x: meteorX, y: 0});
}

function moveCharacter() {
	if(rightPressed && charX < canvas.width-charWidth) {
        charX += charSpeed;
    }
    else if(leftPressed && charX > 0) {
        charX -= charSpeed;
    }

    if (frameCount % 100 == 0) {
    	spawnMeteor();
    }
}

function moveMeteors() {
	for (i = 0; i < meteors.length; i++) {
		meteors[i].y += meteorSpeed;
	}
}

function destroyMeteors() {
	while (true) {
		if (meteors.length > 0 && meteors[0].y > canvas.height + meteorRad * 2) {
			meteors.shift();
		} else {
			break;
		}
	}
}

function checkCollisions() {
	for (i = 0; i < meteors.length; i++) {
		if (charX < meteors[i].x &&
			meteors[i].x < charX + charWidth &&
			meteors[i].y >= canvas.height - (charHeight + platformHeight) && 
			meteors[i].y < canvas.height - platformHeight) {
			gameOver = true;
		}
	}
}

function performAnimations() {
}

function drawBackground() {
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    drawChar();
    drawPlatform();
    drawMeteors();
    drawScoreCounter();

    moveCharacter();
    moveMeteors();
    destroyMeteors();

    checkCollisions();

	if (gameOver) {
		console.log("GAME OVER");
		document.location.reload();
		clearInterval(interval);
	}
    
    frameCount++;
}

</script>

</body>
</html>